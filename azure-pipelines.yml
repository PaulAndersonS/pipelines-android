trigger:
- main

pool:
  vmImage: 'macos-latest'

variables:
  ANDROID_HOME: $(HOME)/Library/Android/sdk
  EMULATOR_NAME: test-emulator

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'
    addToPath: true

- script: |
    echo "##[group]Install Android Command Line Tools"
    mkdir -p $ANDROID_HOME/cmdline-tools
    curl -Lo commandlinetools.zip https://dl.google.com/android/repository/commandlinetools-mac-7583922_latest.zip
    unzip commandlinetools.zip -d $ANDROID_HOME/cmdline-tools
    mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
    echo "##[endgroup]"
  displayName: 'Install Android Command Line Tools'

- script: |
    echo "##[group]Install Android SDK and Tools"
    export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
    sdkmanager --sdk_root=$ANDROID_HOME "platform-tools" "platforms;android-30" "build-tools;30.0.3" "system-images;android-30;google_apis;x86_64"
    yes | sdkmanager --sdk_root=$ANDROID_HOME --licenses
    echo "##[endgroup]"
  displayName: 'Install Android SDK'

- script: |
    echo "##[group]Create and Start Emulator"
    export PATH=$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
    echo "no" | avdmanager create avd -n $EMULATOR_NAME -k "system-images;android-30;google_apis;x86_64" --force
    nohup emulator -avd $EMULATOR_NAME -no-window -no-audio -no-snapshot -netfast -accel off -gpu swiftshader_indirect -no-skin -memory 2048 -partition-size 4096 -no-boot-anim -no-accel &
    echo "Waiting for emulator to start"
    $ANDROID_HOME/platform-tools/adb wait-for-device
    $ANDROID_HOME/platform-tools/adb shell input keyevent 82
    echo "##[endgroup]"
  displayName: 'Create and Start Emulator'

- script: |
    echo "##[group]Run Instrumented Tests"
    ./gradlew connectedAndroidTest
    echo "##[endgroup]"
  displayName: 'Run Instrumented Tests'

trigger:
- main

pool:
  vmImage: 'macos-latest'

variables:
  ANDROID_HOME: /Users/runner/Library/Android/sdk
  ANDROID_SDK_ROOT: /Users/runner/Library/Android/sdk
  EMULATOR_NAME: test-emulator

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'
    addToPath: true

- script: |
    echo "##[group]Install Android Command Line Tools"
    mkdir -p $ANDROID_HOME/cmdline-tools
    curl -Lo commandlinetools.zip https://dl.google.com/android/repository/commandlinetools-mac-7583922_latest.zip
    unzip commandlinetools.zip -d $ANDROID_HOME/cmdline-tools
    mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
    echo "##[endgroup]"
  displayName: 'Install Android Command Line Tools'

- script: |
    echo "##[group]Install Android SDK and Tools"
    export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
    yes | sdkmanager --sdk_root=$ANDROID_HOME "platform-tools" "platforms;android-30" "build-tools;30.0.3" "system-images;android-30;google_apis;x86_64"
    yes | sdkmanager --licenses
    echo "##[endgroup]"
  displayName: 'Install Android SDK'

- script: |
    echo "##[group]Create and Verify Emulator"
    export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
    echo "no" | avdmanager create avd -n $EMULATOR_NAME -k "system-images;android-30;google_apis;x86_64" --force
    avdmanager list avd
    echo "##[endgroup]"
  displayName: 'Create and Verify Emulator'

- script: |
    echo "##[group]Start Emulator"
    export PATH=$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
    nohup emulator -avd $EMULATOR_NAME -no-window -no-audio -no-snapshot -netfast -accel off -gpu swiftshader_indirect -no-skin -memory 2048 -partition-size 4096 -no-boot-anim -no-accel -wipe-data &
    echo "Waiting for emulator to start"
    sleep 60
    $ANDROID_HOME/platform-tools/adb wait-for-device
    $ANDROID_HOME/platform-tools/adb shell input keyevent 82
    echo "##[endgroup]"
  displayName: 'Start Emulator'

- script: |
    echo "##[group]Run Instrumented Tests"
    ./gradlew connectedAndroidTest
    echo "##[endgroup]"
  displayName: 'Run Instrumented Tests'

- script: |
    echo "##[group]Debug Environment"
    echo "ANDROID_HOME=$ANDROID_HOME"
    echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
    echo "PATH=$PATH"
    ls -l $ANDROID_HOME
    ls -l $ANDROID_HOME/cmdline-tools/latest/bin
    ls -l $ANDROID_HOME/emulator
    ls -l $HOME/.android/avd
    avdmanager list avd
    echo "##[endgroup]"
  displayName: 'Debug Environment'
